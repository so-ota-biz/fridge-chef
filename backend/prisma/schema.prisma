generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Management (Supabase Auth integration)
// ============================================

model User {
  id          String   @id @db.Uuid
  displayName String?  @map("display_name")
  firstName   String?  @map("first_name")
  lastName    String?  @map("last_name")
  avatarUrl   String?  @map("avatar_url")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  records Record[]

  @@index([displayName], map: "idx_users_display_name")
  @@map("users")
}

// ============================================
// Categories (食材カテゴリ)
// ============================================

model Category {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(100)
  icon      String   @db.VarChar(50) // アイコン識別子 (vegetables, meat, etc.)
  sortOrder Int      @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  ingredients Ingredient[]

  @@index([sortOrder], map: "idx_categories_sort_order")
  @@map("categories")
}

// ============================================
// Ingredients (食材マスタ)
// ============================================

model Ingredient {
  id         Int      @id @default(autoincrement())
  name       String   @db.VarChar(100)
  categoryId Int      @map("category_id")
  icon       String?  @db.VarChar(50) // アイコン識別子 (将来用、MVP時点ではNULL)
  sortOrder  Int      @map("sort_order")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  category Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  portions Portion[]

  @@index([categoryId], map: "idx_ingredients_category_id")
  @@index([sortOrder], map: "idx_ingredients_sort_order")
  @@map("ingredients")
}

// ============================================
// Recipes (レシピ)
// ============================================

model Recipe {
  id          Int      @id @default(autoincrement())
  title       String   @db.VarChar(255)
  description String?  @db.Text
  cookingTime Int      @map("cooking_time") // 分単位
  difficulty  Int // 1: 超簡単, 2: 普通, 3: ちょっと頑張る
  servings    Int // 何人分
  imageUrl    String?  @map("image_url") @db.VarChar(255) // AI生成画像URL
  imagePrompt String?  @map("image_prompt") @db.Text // AI画像生成用プロンプト
  genre       Int // 0: 和食, 1: 洋食, 2: 中華, 3: エスニック, 4: その他
  calories    Int? // 1人分の概算カロリー
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  portions Portion[]
  steps    Step[]
  records  Record[]

  @@index([genre], map: "idx_recipes_genre")
  @@index([difficulty], map: "idx_recipes_difficulty")
  @@index([cookingTime], map: "idx_recipes_cooking_time")
  @@map("recipes")
}

// ============================================
// Portions (レシピの材料)
// ============================================

model Portion {
  id           Int      @id @default(autoincrement())
  recipeId     Int      @map("recipe_id")
  ingredientId Int?     @map("ingredient_id") // NULLの場合はユーザー自由入力食材
  name         String?  @db.VarChar(100) // ユーザー自由入力食材名（ingredientIdがNULLの場合）
  amount       String   @db.VarChar(50) // 分量（例: "200", "大さじ2"）
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  recipe     Recipe      @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  ingredient Ingredient? @relation(fields: [ingredientId], references: [id], onDelete: SetNull)

  @@index([recipeId], map: "idx_portions_recipe_id")
  @@index([ingredientId], map: "idx_portions_ingredient_id")
  @@map("portions")
}

// ============================================
// Steps (調理手順)
// ============================================

model Step {
  id          Int      @id @default(autoincrement())
  recipeId    Int      @map("recipe_id")
  stepNumber  Int      @map("step_number")
  instruction String   @db.Text
  imageUrl    String?  @map("image_url") @db.VarChar(255)
  tips        String?  @db.Text // コツ・ポイント
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId, stepNumber], map: "idx_steps_recipe_id_step_number")
  @@map("steps")
}

// ============================================
// Records (料理記録)
// ============================================

model Record {
  id           Int      @id @default(autoincrement())
  userId       String   @map("user_id") @db.Uuid
  recipeId     Int      @map("recipe_id")
  userImageUrl String?  @map("user_image_url") @db.VarChar(255) // ユーザーが撮影した料理写真
  rating       Int? // 1-5の評価
  memo         String?  @db.Text // ユーザーのメモ
  cookedAt     DateTime @map("cooked_at") @db.Timestamptz(6) // 調理日時
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_records_user_id")
  @@index([recipeId], map: "idx_records_recipe_id")
  @@index([cookedAt], map: "idx_records_cooked_at")
  @@map("records")
}
